<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø´Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† ğŸ’¬</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #0088cc; --bg-light: #f0f2f5; --my-msg: #dcf8c6; --special-bg: #e1f5fe; }
        body { font-family: 'Cairo', sans-serif; margin: 0; background: var(--bg-light); height: 100vh; display: flex; flex-direction: column; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #login-screen { display: flex; height: 100vh; justify-content: center; align-items: center; background: #e5ddd5; }
        .login-box { background: white; padding: 30px; border-radius: 10px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 90%; max-width: 350px; }
        input, textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; text-align: center; font-family: 'Cairo'; }
        button { width: 100%; padding: 10px; border: none; background: var(--primary); color: white; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 5px; }
        
        /* Ø²Ø± Ø·Ù„Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨ */
        .outline-btn { background: white; border: 1px solid var(--primary); color: var(--primary); margin-top: 10px; }
        
        /* Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 85%; max-width: 320px; text-align: center; }

        /* Ø¨Ù‚ÙŠØ© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª (ÙƒÙ…Ø§ Ù‡ÙŠ) */
        #app-container { display: none; height: 100vh; overflow: hidden; }
        .sidebar { width: 30%; background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; }
        .sidebar-header { padding: 15px; background: #eee; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .general-chat-btn { padding: 15px; background: var(--special-bg); cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 2px solid #b3e5fc; font-weight: bold; color: #0277bd; }
        .user-list { flex: 1; overflow-y: auto; }
        .user-item { padding: 15px; border-bottom: 1px solid #f1f1f1; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .user-avatar { width: 40px; height: 40px; background: #ddd; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background: #e5ddd5; position: relative; }
        .chat-header { padding: 10px 15px; background: #eee; display: flex; align-items: center; gap: 10px; height: 60px; box-sizing: border-box; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 75%; padding: 8px 12px; border-radius: 8px; font-size: 0.95rem; position: relative; word-wrap: break-word; display: flex; flex-direction: column; }
        .msg-me { align-self: flex-end; background: var(--my-msg); border-radius: 8px 0 8px 8px; }
        .msg-other { align-self: flex-start; background: white; border-radius: 0 8px 8px 8px; }
        .sender-label { font-size: 0.7rem; color: #e53935; font-weight: bold; margin-bottom: 2px; }
        .msg-time { font-size: 0.65rem; color: #999; align-self: flex-end; margin-top: 3px; }
        .msg-img { max-width: 100%; border-radius: 5px; margin-top: 5px; display: block; cursor: pointer; }
        .input-zone { padding: 10px; background: #f0f0f0; display: flex; gap: 10px; align-items: center; }
        .input-zone input { margin: 0; text-align: right; }
        .icon-btn { background: none; color: #555; font-size: 1.2rem; width: auto; padding: 5px; }
        @media (max-width: 768px) {
            .sidebar { width: 100%; position: absolute; height: 100%; z-index: 2; transition: transform 0.3s; }
            .sidebar.hidden { transform: translateX(100%); }
            .chat-area { width: 100%; }
            #back-btn { display: block !important; }
        }
        #back-btn { display: none; }
        #lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 2000; }
        #lightbox img { max-width: 95%; max-height: 95%; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>ğŸ’¬ Ø´Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</h2>
            <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button id="login-btn">Ø¯Ø®ÙˆÙ„</button>
            
            <button class="outline-btn" onclick="document.getElementById('request-modal').style.display='flex'">Ø·Ù„Ø¨ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
        </div>
    </div>

    <div id="request-modal" class="modal">
        <div class="modal-content">
            <h3>ğŸ“ Ø·Ù„Ø¨ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</h3>
            <input type="text" id="req-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">
            <input type="email" id="req-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <input type="text" id="req-reason" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø·Ù„Ø¨ / Ø§Ù„Ù…Ù†ØµØ¨">
            <button onclick="sendAccountRequest()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
            <button class="outline-btn" onclick="document.getElementById('request-modal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div id="app-container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span id="my-name">...</span>
                <button onclick="logout()" style="width:auto; background:red; font-size:0.8rem">Ø®Ø±ÙˆØ¬</button>
            </div>
            <div class="general-chat-btn" onclick="openPublicChat()">
                <div class="user-avatar" style="background:#0277bd; color:white">ğŸ“¢</div>
                <span>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</span>
            </div>
            <div class="user-list" id="users-list"></div>
        </div>

        <div class="chat-area">
            <div class="chat-header" id="chat-header" style="display:flex">
                <button id="back-btn" class="icon-btn" onclick="showSidebar()">âœ</button>
                <div class="user-avatar" id="current-chat-avatar">ğŸ“¢</div>
                <span id="current-chat-name" style="font-weight:bold">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</span>
            </div>
            <div class="chat-messages" id="messages-box"></div>
            <div class="input-zone" id="input-zone">
                <button class="icon-btn" onclick="document.getElementById('file-input').click()">ğŸ“·</button>
                <input type="file" id="file-input" accept="image/*" hidden onchange="sendFile(this)">
                <input type="text" id="msg-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
                <button class="icon-btn" onclick="sendMessage()">â¤</button>
            </div>
        </div>
    </div>
    
    <div id="lightbox" onclick="this.style.display='none'"><img id="lightbox-img" src=""></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      const firebaseConfig = {
  apiKey: "AIzaSyC12wP3jPuylQzJe2HNaiDFJgNSMf50jaI",
  authDomain: "steps4u-aea0c.firebaseapp.com",
  databaseURL: "https://steps4u-aea0c-default-rtdb.firebaseio.com",
  projectId: "steps4u-aea0c",
  storageBucket: "steps4u-aea0c.firebasestorage.app",
  messagingSenderId: "316135301602",
  appId: "1:316135301602:web:2f9a119f50093e8ac899bb",
  measurementId: "G-S27FV5E84B"
};

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
// Ø±Ø§Ø¨Ø· ØµÙˆØª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (ØµÙˆØª Pop Ø®ÙÙŠÙ)
// Ø±Ø§Ø¨Ø· ØµÙˆØª "Pop" Ø³Ø±ÙŠØ¹ ÙˆÙ…ÙˆØ«ÙˆÙ‚
const sendSound = new Audio('https://actions.google.com/sounds/v1/cartoon/pop.ogg');
const receiveSound = new Audio('https://cdn.pixabay.com/audio/2022/03/10/audio_c8c8a73467.mp3'); // ØµÙˆØª Ù…Ø®ØªÙ„Ù
        let currentUser = null;
        let activeChatRef = null;

        // 1. Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                document.getElementById('my-name').innerText = "ğŸ‘¤ " + user.email.split('@')[0];
                saveUserToDB(user);
                loadUsersList();
                openPublicChat();
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
            }
        });

        // 2. Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
        window.sendAccountRequest = () => {
            const name = document.getElementById('req-name').value;
            const email = document.getElementById('req-email').value;
            const reason = document.getElementById('req-reason').value;

            if(!name || !email) {
                alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ");
                return;
            }

            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            push(ref(db, 'account_requests'), {
                name: name,
                email: email,
                reason: reason,
                timestamp: Date.now(),
                date: new Date().toLocaleDateString('ar-EG')
            })
            .then(() => {
                alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!\nØ³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù…Ø´Ø±Ù Ø¨Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù‚Ø±ÙŠØ¨Ø§Ù‹.");
                document.getElementById('request-modal').style.display = 'none';
                // ØªØµÙÙŠØ± Ø§Ù„Ø­Ù‚ÙˆÙ„
                document.getElementById('req-name').value = "";
                document.getElementById('req-email').value = "";
                document.getElementById('req-reason').value = "";
            })
            .catch((error) => {
                alert("Ø®Ø·Ø£: " + error.message);
            });
        };

        // ... (Ø¨Ø§Ù‚ÙŠ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª ÙƒÙ…Ø§ Ù‡Ùˆ ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©) ...
        
        window.openPublicChat = () => setupChatView("Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¹Ø§Ù…Ø©", "ğŸ“¢", ref(db, 'public_chat_messages'));

        window.openPrivateChat = (targetUser) => {
            const chatId = [currentUser.uid, targetUser.uid].sort().join('_');
            setupChatView(targetUser.name, "ğŸ‘¤", ref(db, 'private_chats/' + chatId));
        };

        function setupChatView(name, avatar, refPath) {
            document.getElementById('current-chat-name').innerText = name;
            document.getElementById('current-chat-avatar').innerText = avatar;
            if(window.innerWidth <= 768) document.getElementById('sidebar').classList.add('hidden');
            if (activeChatRef) off(activeChatRef);
            activeChatRef = refPath;
            loadMessages();
        }

        function loadMessages() {
            const box = document.getElementById('messages-box');
            box.innerHTML = ''; 
            onValue(activeChatRef, (snapshot) => {
                box.innerHTML = '';
                const data = snapshot.val();
                if (data) {
                    Object.values(data).forEach(msg => {
                        const div = document.createElement('div');
                        const isMe = msg.senderId === currentUser.uid;
						const msgs = Object.values(data);
            const lastMsg = msgs[msgs.length - 1];
                        div.className = `msg ${isMe ? 'msg-me' : 'msg-other'}`;
                        let senderInfo = (!isMe) ? `<span class="sender-label">~ ${msg.senderName}</span>` : '';
                        let content = `<div dir="auto">${msg.text}</div>`;
						if (lastMsg.senderId !== currentUser.uid) {
                 // Ù‡Ø°Ø§ ÙŠØ¹Ù†ÙŠ Ø£Ù† Ø´Ø®ØµØ§Ù‹ Ø¢Ø®Ø± Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                 receiveSound.play().catch(e => console.log("Interact first"));
            }
                        if (msg.image) content += `<img src="${msg.image}" class="msg-img" onclick="viewImage(this.src)">`;
                        div.innerHTML = `${senderInfo}${content}<span class="msg-time">${msg.time}</span>`;
                        box.appendChild(div);
                    });
                    box.scrollTop = box.scrollHeight;
                }
            });
        }

        window.sendMessage = () => {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();// ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù†Øµ Ø£Ùˆ ØµÙˆØ±Ø©
            if (!text && !selectedImageBase64) return; // (Ø£Ùˆ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø°ÙŠ ØªØ³ØªØ®Ø¯Ù…Ù‡ Ù„Ù„ØµÙˆØ±Ø©)

            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            sendData(text, null);
            
            // ğŸ‘‡ğŸ‘‡ ÙƒÙˆØ¯ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø·ÙˆØ± ğŸ‘‡ğŸ‘‡
            sendSound.currentTime = 0; // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØµÙˆØª Ù„Ù„Ø¨Ø¯Ø§ÙŠØ© (Ù„Ø³Ø±Ø¹Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±)
            sendSound.play()
                .then(() => console.log("ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ğŸ”Š"))
                .catch((error) => alert("Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹ Ø§Ù„ØµÙˆØª: " + error.message));

            input.value = ''; 
        };

        window.sendFile = (input) => {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => sendData("", e.target.result);
                reader.readAsDataURL(file);
            }
        };

        function sendData(text, img) {
            if (!text && !img) return;
            push(activeChatRef, {
                senderId: currentUser.uid,
                senderName: currentUser.email.split('@')[0],
                text: text || "",
                image: img || null,
                time: new Date().toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'}),
                timestamp: Date.now()
            });
        }

        function saveUserToDB(user) {
            set(ref(db, 'users/' + user.uid), {
                email: user.email, name: user.email.split('@')[0], uid: user.uid
            });
        }

        function loadUsersList() {
            onValue(ref(db, 'users'), (snapshot) => {
                const list = document.getElementById('users-list');
                list.innerHTML = '';
                const users = snapshot.val();
                if (users) {
                    Object.values(users).forEach(u => {
                        if (u.uid === currentUser.uid) return;
                        const item = document.createElement('div');
                        item.className = 'user-item';
                        item.innerHTML = `<div class="user-avatar">ğŸ‘¤</div><span>${u.name}</span>`;
                        item.onclick = () => openPrivateChat(u);
                        list.appendChild(item);
                    });
                }
            });
        }

        const performLogin = () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => alert("Ø®Ø·Ø£: " + err.message));
        };
        document.getElementById('login-btn').addEventListener('click', performLogin);

        window.logout = () => signOut(auth).then(() => location.reload());
        window.showSidebar = () => document.getElementById('sidebar').classList.remove('hidden');
        window.viewImage = (src) => { document.getElementById('lightbox-img').src = src; document.getElementById('lightbox').style.display = 'flex'; };

    </script>
</body>
</html>